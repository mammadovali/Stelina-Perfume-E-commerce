@model BlogPost

@{
    ViewData["Title"] = "Details";

    IEnumerable<BlogPostComment> GetComments(BlogPostComment parent)
    {
        if (parent.ParentId != null)
            yield return parent;

        foreach (var item in parent.Children.SelectMany(c => GetComments(c)))
        {
            yield return item;
        }

    }
}

<div class="main-content main-content-blog single right-sidebar" style="padding-bottom: 0px;">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb-trail breadcrumbs">
                    <ul class="trail-items breadcrumb">
                        <li class="trail-item trail-begin">
                            <a asp-controller="home" asp-action="index">Home</a>
                        </li>
                        <li class="trail-item">
                            <a asp-action="index" asp-controller="blog">Our blog</a>
                        </li>
                        <li class="trail-item trail-end active">
                            @Model.Title
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="content-area content-blog col-lg-9 col-md-8 col-sm-12 col-xs-12">
                <div class="site-main">
                    <div class="post-item">
                        <div class="post-format">
                            <img src="~/uploads/images/@Model.ImagePath" alt="blog-image" style="height: 511px; object-fit: contain; width: 100%" />
                        </div>
                        <div class="post-infor">
                            <div class="category-blog">
                                <a>Category: @Model.Category?.Name</a>
                            </div>

                            <ul class="blog-post-data">
                                <li class="post-date">
                                    Post date:<a>@Model.PublishedDate?.ToString("dd MMM, yyyy")</a>
                                </li>
                                <li class="post-view">
                                    <span class="fa fa-eye"></span>533 Views
                                </li>
                                <li class="post-comments">
                                    <span><i class="fa fa-comment"></i></span><span class="px-1">0</span>Comments
                                </li>
                            </ul>


                            <h3 class="post-title">
                                <a>@Model.Title</a>
                            </h3>
                            <div class="main-info-post">
                                @Html.Raw(Model.Body)
                            </div>
                        </div>
                    </div>
                    @await Component.InvokeAsync("RelatedPosts", new {id = @Model.Id})

                    <div class="tags tags-blog">
                        <h3 class="widgettitle">Tags:</h3>
                        <ul class="tagcloud">
                            @foreach (var item in Model.TagCloud)
                            {
                                <li class="tag-cloud-link">
                                    <a>@item.Tag.Text</a>
                                </li>
                            }

                        </ul>
                    </div>
                    <div class="comments-area">
                        <ul class="comment-list">
                            <li class="comment">
                                @foreach (var comment in Model.Comments.Where(c => c.ParentId == null))
                                {
                                    <div class="comment-item" id="c-@comment.Id" data-comment-id="@comment.Id">
                                        <div class="author-view">
                                            <div class="author">
                                                <h3 class="name">@($"{comment.CreatedByUser?.Name} {comment.CreatedByUser?.Surname}")</h3>
                                            </div>
                                            <div class="date-reply-comment">
                                                <span class="date-comment">@comment.CreatedDate.ToString("dd.MM.yyyy")</span>
                                            </div>
                                        </div>
                                        <div class="comment-body">
                                            <div class="comment-content">
                                                <p>
                                                    @comment.Text
                                                </p>
                                            </div>
                                            <div class="comment-reply-link">
                                                <a class="Comment btn-comment-reply">
                                                    <i class="icon fa fa-commenting"
                                                   aria-hidden="true"></i>
                                                    Reply
                                                </a>
                                            </div>
                                        </div>
                                    </div>

                                    @foreach (var subComment in GetComments(comment))
                                    {
                                        <ul class="children">
                                            <li>
                                                <div class="comment-item" id="c-@subComment.Id" data-comment-id="@subComment.Id">
                                                    <div class="author-view">
                                                        <div class="author">
                                                            <h3 class="name">@($"{subComment.CreatedByUser?.Name} {subComment.CreatedByUser?.Surname}")</h3>
                                                        </div>
                                                        <div class="date-reply-comment">
                                                            <span class="date-comment"> @subComment.CreatedDate.ToString("dd.MM.yyyy") </span>
                                                        </div>
                                                    </div>
                                                    <div class="comment-body">
                                                        <div class="comment-content">
                                                            <p>
                                                                @subComment.Text
                                                            </p>
                                                        </div>
                                                        <div class="comment-reply-link">
                                                            <a class="Comment btn-comment-reply">
                                                                <i class="fa fa-commenting"
                                                           aria-hidden="true"></i>
                                                                Reply
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </li>
                                        </ul>
                                    }
                                }
                            </li>
                        </ul>

                        <h3 class="custom_blog_title">
                            Comments <span class="count">(@Model.Comments.Count)</span>

                        </h3>
                        <div id="replyToComment"></div>
                         <input type="hidden" name="postId" value="@Model.Id" />
                        <form class="comment-form" method="post" id="replyForm">

                            <p class="comment-reply-content">
                                <textarea rows="6"
                                          name="comment"
                                          placeholder="Write your comment"
                                          id="comment-text"
                                          class="input-form"></textarea>
                            </p>
                            <p class="form-submit">
                                <span class="controll">
                                    <button type="submit" class="submit button">POST A COMMENT</button>
                                </span>
                            </p>
                        </form>
                    </div>
                </div>
            </div>
            <div class="sidebar sidebar-single-blog col-lg-3 col-md-4 col-sm-12 col-xs-12">
                <div class="wrapper-sidebar">
                    <div class="widget widget-socials">
                        <h3 class="widgettitle">Follow us</h3>
                        <div class="content-socials">
                            <div class="social-list">
                                <a href="#" target="_blank" class="social-item">
                                    <i class="fa fa-facebook-square" aria-hidden="true"></i>
                                </a>
                                <a href="#" target="_blank" class="social-item">
                                    <i class="fa fa-twitter" aria-hidden="true"></i>
                                </a>
                                <a href="#" target="_blank" class="social-item">
                                    <i class="fa fa-instagram" aria-hidden="true"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="widget widget-post">
                        <h3 class="widgettitle">Popular Articles</h3>
                        <ul class="stelina-posts">
                            <li class="widget-post-item">
                                <div class="thumb-blog">
                                    <img src="~/assets/images/sidebar-post1.jpg" alt="img" />
                                </div>
                                <div class="post-content">
                                    <div class="cat">
                                        <a href="#">Life Style</a>
                                    </div>
                                    <h5 class="post-title">
                                        <a href="#">9 Quicks Tips That Will Change <span>[...]</span></a>
                                    </h5>
                                </div>
                            </li>
                            <li class="widget-post-item">
                                <div class="thumb-blog">
                                    <img src="~/assets/images/sidebar-post2.jpg" alt="img" />
                                </div>
                                <div class="post-content">
                                    <div class="cat">
                                        <a href="#">Lookbook</a>
                                    </div>
                                    <h5 class="post-title">
                                        <a href="#">9 Quicks Tips That Will Change <span>[...]</span></a>
                                    </h5>
                                </div>
                            </li>
                            <li class="widget-post-item">
                                <div class="thumb-blog">
                                    <img src="~/assets/images/sidebar-post3.jpg" alt="img" />
                                </div>
                                <div class="post-content">
                                    <div class="cat">
                                        <a href="#">Street Style</a>
                                    </div>
                                    <h5 class="post-title">
                                        <a href="#">9 Quicks Tips That Will Change <span>[...]</span></a>
                                    </h5>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section addjs{
<script class="removable">
    $(document).ready(function(){
        $(".btn-comment-reply").click(function(e){
            e.preventDefault();

            $("#replyToComment").html("<a href='javascript:removeSelectedReply()' class='remove-selected-comment' >&times</a>").append($(e.currentTarget).closest(".comment-item").clone());
        })

        $("#replyForm").submit(function(e) {
            e.preventDefault();

            let formData = new FormData(e.currentTarget);

            let toCommentId = $(`#replyToComment div.comment-item`).data("comment-id");


           //console.log("commentId",toCommentId);

            if(toCommentId != undefined){
                formData.set("commentId", toCommentId);
            }


            $.ajax({
                url: `@Url.Action("PostComment", "Blog")`,
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                dataType: "json",
                success: function(res){
                    //console.log(res);
                },
                error: function(res){
                    if(res.statusText == "parsererror"){
                        if(toCommentId != undefined){
                           $(res.responseText).insertAfter($(`#c-${toCommentId}`));

                           $("#replyToComment").html("");
                           e.currentTarget.reset();
                           $("#comment-text").val("");
                        }
                        else
                        {
                            $("div.comments ul").append($(res.responseText))
                            $("#comment-text").val("");
                        }
                    }

                    //console.warn(res);
                }
            });
        })
    })

    function removeSelectedReply(el) {
        $("#replyToComment").html("");
    }
</script>
}
